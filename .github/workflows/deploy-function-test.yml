name: Deploy Function (TEST Flex)

on:
  push:
    branches: [ flex-test ]                 # ← テスト専用
    paths:
      - "ProcessAudioFunction/**"
      - ".github/workflows/deploy-function-test.yml"
  workflow_dispatch:                         # ← 手動実行も可能に

env:
  AZURE_FUNCTIONAPP_NAME: gijiro-flex-plan   # ← 新しい Flex Function
  AZURE_RESOURCE_GROUP: general51

jobs:
  deploy-func:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ProcessAudioFunction
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install deps (for build)
        run: |
          python -m pip install -r requirements.txt -t .python_packages/lib/site-packages

      - name: Zip & Deploy
        run: |
          zip -r ../function.zip .
          az functionapp deployment source config-zip \
            --name "$AZURE_FUNCTIONAPP_NAME" \
            --resource-group "$AZURE_RESOURCE_GROUP" \
            --src ../function.zip
