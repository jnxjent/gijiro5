<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>議事郎</title>

  <!-- ビルド／デプロイ時に CI 等で置換 -->
  <meta name="function-key" content="%FUNCTION_KEY%">

  <!-- ★ フロント側容量上限 → サーバーから渡す -->
  <meta name="max-upload-bytes" content="{{ max_bytes }}"> 

  <style>
    /* ───────── ベース ───────── */
    body{
      font-family:'Helvetica',sans-serif;
      background:linear-gradient(135deg,#74ebd5 0%,#ACB6E5 100%);
      margin:0;
      display:flex;justify-content:center;align-items:center;
      height:100vh;padding-top:10px;color:#333;
    }
    .container{
      box-sizing:border-box;
      background:rgba(255,255,255,.9);
      border-radius:10px;
      box-shadow:0 4px 15px rgba(0,0,0,.2);
      padding:20px;
      max-width:540px;width:100%;
      display:flex;flex-direction:column;align-items:center;text-align:center;
    }
    .logo{width:250px;height:auto;margin:-10px 0 10px -10px;}

    p{margin:3px 0 8px;font-size:14px;color:#555;line-height:1.4;}

    .file-input{display:flex;align-items:center;margin:8px auto;}
    .file-input label{
      width:50px;text-align:right;margin-right:8px;font-size:14px;font-weight:bold;
    }
    .file-input input[type=file]{
      padding:8px;border:1px solid #ddd;border-radius:5px;font-size:14px;
    }

    button{
      background:#007BFF;color:#fff;border:none;
      padding:8px 16px;border-radius:5px;font-size:14px;font-weight:bold;
      cursor:pointer;transition:background .2s;
    }
    button:hover{background:#0056b3;}

    .upload-btn{margin:14px auto 0;display:block;}

    .download-link{margin:12px 0;font-size:14px;}
    .download-link a{color:#007BFF;text-decoration:none;font-weight:bold;}
    .download-link a:hover{text-decoration:underline;}

    .keyword-button{margin-top:14px;text-align:center;}
    .keyword-button button{
      background:#28a745;display:block;margin:0 auto;border:none;
      padding:6px 12px;font-size:14px;border-radius:5px;font-weight:bold;
      transition:background .2s;
    }
    .keyword-button button:hover{background:#218838;}
    .keyword-desc{font-size:14px;margin-top:6px;color:#555;}

    .status-msg{margin-top:12px;font-size:14px;color:#333;}
  </style>
</head>

<body>
  <div class="container">
    <img src="static/images/gijiro-logo-professional.svg" alt="議事郎ロゴ" class="logo">

    <p>音声ファイル(.wav, .mp4, .m4a,.mp3)と議事録テンプレート(.docx, .doc)を<br>
       アップロードすると、記載済み議事録が自動でダウンロードされます。</p>

    <div class="file-input">
      <label for="audio_file">音声</label>
      <input type="file" id="audio_file" accept="audio/*">
    </div>
    <div class="file-input">
      <label for="word_file">ワード</label>
      <input type="file" id="word_file" accept=".doc,.docx">
    </div>

    <button class="upload-btn" onclick="startUpload()">アップロード</button>
    <div class="status-msg" id="status_msg"></div>

    <div class="download-link">
      議事録テンプレートは&nbsp;
      <a href="https://midac19stoyhggrda5qr5ae.blob.core.windows.net/mom/word/アップロード用議事録テンプレート.docx"
         download rel="noopener noreferrer">こちら</a>&nbsp;からダウンロード
    </div>

    <div class="keyword-button">
      <button onclick="location.href='/keywords'">キーワード登録</button>
      <div class="keyword-desc">
        よく使う用語や専門用語は上（↑↑↑）から登録できます。
      </div>
    </div>
  </div>

  <script>
    // ===== 共通ヘルパ =====
    const FUNCTION_KEY = document.querySelector('meta[name="function-key"]').getAttribute('content');

    // ★ ここだけ変更 → サーバー値を直接使う
    const MAX_UPLOAD_BYTES = {{ max_bytes|int }};

    function bytesToMB(b){ return Math.round((b/1024/1024)*10)/10; }

    function gotoError(code, message, jobId) {
      const params = new URLSearchParams({
        code: String(code || 500),
        message: (message || "").slice(0, 500),
        path: location.pathname
      });
      if (jobId) params.set("job_id", jobId);
      location.href = "/error?" + params.toString();
    }

    async function fetchJsonWithErrors(url, init, fallbackCode=500) {
      try {
        const res = await fetch(url, init);
        const ct = res.headers.get("content-type") || "";
        const maybeJson = ct.includes("application/json");
        let data = null;

        if (maybeJson) {
          data = await res.json().catch(()=>null);
        } else {
          data = { message: await res.text().catch(()=>null) };
        }

        if (!res.ok) {
          const code = res.status || fallbackCode;
          const msg  = (data && (data.message || data.error)) || `HTTP ${code} error`;
          gotoError(code, msg);
          return Promise.reject(new Error(msg));
        }
        return data ?? {};
      } catch (e) {
        gotoError(408, "ネットワークが不安定です。再度お試しください。");
        throw e;
      }
    }

    async function startUpload(){
      const audioFile = document.getElementById("audio_file").files[0];
      const wordFile  = document.getElementById("word_file").files[0];
      const statusMsg = document.getElementById("status_msg");

      if(!audioFile||!wordFile){
        alert("両方のファイルを選択してください。");
        return;
      }

      const totalBytes = (audioFile.size||0) + (wordFile.size||0);
      if (totalBytes > MAX_UPLOAD_BYTES) {
        gotoError(413, `アップロード上限(${bytesToMB(MAX_UPLOAD_BYTES)}MB)を超えています。現在: ${bytesToMB(totalBytes)}MB`);
        return;
      }

      statusMsg.innerText="アップロード中...";

      async function uploadToBlob(file,path,isAudio=true){
        const sasRes = await fetchJsonWithErrors(`/api/blob/sas?name=${encodeURIComponent(path)}`, { method:"GET" }, 502);
        const { uploadUrl, blobUrl } = sasRes || {};
        if (!uploadUrl || !blobUrl) {
          gotoError(500, "アップロード先の取得に失敗しました。");
          throw new Error("SAS missing");
        }

        const headers={"x-ms-blob-type":"BlockBlob"};
        headers["Content-Type"]=file.type||
          (isAudio?"audio/mp4":
           "application/vnd.openxmlformats-officedocument.wordprocessingml.document");

        const putRes = await fetch(uploadUrl,{method:"PUT",headers,body:file}).catch(()=>null);
        if (!putRes || !putRes.ok) {
          const code = putRes ? putRes.status : 408;
          gotoError(code, "ストレージへのアップロードに失敗しました。");
          throw new Error("Blob PUT failed");
        }
        return blobUrl;
      }

      try{
        const audioBlobUrl=await uploadToBlob(audioFile,"audio/"+audioFile.name,true);
        const wordBlobUrl =await uploadToBlob(wordFile ,"word/"+wordFile.name ,false);
        statusMsg.innerText="ジョブ登録中...";

        const data = await fetchJsonWithErrors("/api/process",{
          method:"POST",
          headers:{
            "Content-Type":"application/json",
            "x-functions-key":FUNCTION_KEY
          },
          body:JSON.stringify({blobUrl:audioBlobUrl,templateBlobUrl:wordBlobUrl})
        }, 500);

        if (!data || !data.jobId) {
          gotoError(500, "ジョブ登録に失敗しました。");
          return;
        }

        statusMsg.innerText=`ジョブID: ${data.jobId} 登録完了。処理中...`;
        pollForResult(data.jobId);

      }catch(err){
        console.error(err);
        statusMsg.innerText="アップロードまたは処理開始に失敗しました。";
      }
    }

    async function pollForResult(jobId){
      const statusMsg=document.getElementById("status_msg");
      const interval=setInterval(async()=>{
        try{
          const res = await fetch(`/api/process/${jobId}/status`,
                                  {headers:{"x-functions-key":FUNCTION_KEY}});
          if (res.status === 200) {
            clearInterval(interval);
            statusMsg.innerText="処理完了！結果をダウンロード中...";
            window.location.href="/results/"+jobId;
          } else if (res.status === 202) {
          } else if (res.status === 504) {
            clearInterval(interval);
            gotoError(504, "処理が時間内に完了しませんでした。", jobId);
          } else if (res.status === 413) {
            clearInterval(interval);
            gotoError(413, "アップロード上限を超えています。", jobId);
          } else if (res.status >= 400) {
            clearInterval(interval);
            const msg = await res.text().catch(()=> "処理中にエラーが発生しました。");
            gotoError(res.status, msg, jobId);
          }
        }catch(e){
          clearInterval(interval);
          gotoError(408, "結果の取得中にネットワークエラーが発生しました。", jobId);
        }
      },3000);
    }
  </script>
</body>
</html>
